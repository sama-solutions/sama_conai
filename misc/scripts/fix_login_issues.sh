#!/bin/bash\n\n# Script de correction des problÃ¨mes de login et de boucle infinie\necho \"ðŸ”§ CORRECTION DES PROBLÃˆMES DE LOGIN SAMA CONAI\"\necho \"=\" | head -c 50; echo\n\n# 1. VÃ©rifier l'Ã©tat actuel\necho \"\"\necho \"ðŸ“Š 1. Ã‰tat actuel des services...\"\necho \"Application mobile (3005):\"\ncurl -s -I http://localhost:3005 | head -1 || echo \"âŒ Non accessible\"\n\necho \"Backend Odoo (8077):\"\ncurl -s -I http://localhost:8077 | head -1 || echo \"âŒ Non accessible\"\n\necho \"Proxy iframe (8078):\"\ncurl -s -I http://localhost:8078 | head -1 || echo \"âŒ Non accessible\"\n\n# 2. ArrÃªter les processus problÃ©matiques\necho \"\"\necho \"â¹ï¸ 2. ArrÃªt des processus existants...\"\npkill -f \"node server.js\" 2>/dev/null && echo \"âœ… Serveur mobile arrÃªtÃ©\" || echo \"â„¹ï¸ Serveur mobile dÃ©jÃ  arrÃªtÃ©\"\npkill -f \"node proxy_server.js\" 2>/dev/null && echo \"âœ… Proxy arrÃªtÃ©\" || echo \"â„¹ï¸ Proxy dÃ©jÃ  arrÃªtÃ©\"\n\n# Attendre que les processus se terminent\nsleep 3\n\n# 3. Nettoyer les fichiers temporaires\necho \"\"\necho \"ðŸ§¹ 3. Nettoyage des fichiers temporaires...\"\nrm -f pids/*.pid 2>/dev/null || true\nrm -f logs/mobile_app.log 2>/dev/null || true\nrm -f logs/proxy_server.log 2>/dev/null || true\necho \"âœ… Fichiers temporaires nettoyÃ©s\"\n\n# 4. VÃ©rifier la configuration Odoo\necho \"\"\necho \"ðŸ›ï¸ 4. VÃ©rification de la configuration Odoo...\"\nif curl -s http://localhost:8077/web/login | grep -q \"oe_login_form\"; then\n    echo \"âœ… Page de login Odoo accessible\"\n    \n    # VÃ©rifier si le formulaire est masquÃ©\n    if curl -s http://localhost:8077/web/login | grep -q \"d-none\"; then\n        echo \"âš ï¸ Formulaire de login masquÃ© - RedÃ©marrage d'Odoo nÃ©cessaire\"\n        \n        # RedÃ©marrer Odoo si nÃ©cessaire\n        echo \"ðŸ”„ RedÃ©marrage d'Odoo...\"\n        pkill -f \"python3 odoo-bin\" 2>/dev/null || true\n        sleep 5\n        \n        # RedÃ©marrer Odoo en arriÃ¨re-plan\n        python3 odoo-bin -c odoo_iframe_config.conf -d sama_conai_analytics \\\n          --addons-path=/var/odoo/odoo18/addons,/home/grand-as/psagsn/custom_addons \\\n          --http-port=8077 --log-level=info \\\n          --logfile=logs/odoo.log --pidfile=pids/odoo.pid &\n        \n        echo \"â³ Attente du redÃ©marrage d'Odoo...\"\n        for i in {1..30}; do\n            if curl -s http://localhost:8077 >/dev/null 2>&1; then\n                echo \"âœ… Odoo redÃ©marrÃ© avec succÃ¨s\"\n                break\n            fi\n            echo \"   Tentative $i/30...\"\n            sleep 2\n        done\n    else\n        echo \"âœ… Formulaire de login Odoo visible\"\n    fi\nelse\n    echo \"âŒ Page de login Odoo inaccessible\"\n    echo \"ðŸ”„ RedÃ©marrage d'Odoo nÃ©cessaire...\"\n    \n    # Forcer le redÃ©marrage d'Odoo\n    pkill -f \"python3 odoo-bin\" 2>/dev/null || true\n    sleep 5\n    \n    python3 odoo-bin -c odoo_iframe_config.conf -d sama_conai_analytics \\\n      --addons-path=/var/odoo/odoo18/addons,/home/grand-as/psagsn/custom_addons \\\n      --http-port=8077 --log-level=info \\\n      --logfile=logs/odoo.log --pidfile=pids/odoo.pid &\n    \n    echo \"â³ Attente du dÃ©marrage d'Odoo...\"\n    for i in {1..30}; do\n        if curl -s http://localhost:8077 >/dev/null 2>&1; then\n            echo \"âœ… Odoo dÃ©marrÃ© avec succÃ¨s\"\n            break\n        fi\n        echo \"   Tentative $i/30...\"\n        sleep 2\n    done\nfi\n\n# 5. DÃ©marrer le proxy avec configuration corrigÃ©e\necho \"\"\necho \"ðŸ”— 5. DÃ©marrage du proxy iframe...\"\ncd mobile_app_web\n\n# VÃ©rifier que proxy_server.js existe et est configurÃ©\nif [ -f \"proxy_server.js\" ]; then\n    # DÃ©marrer le proxy en arriÃ¨re-plan\n    node proxy_server.js > ../logs/proxy_server.log 2>&1 &\n    PROXY_PID=$!\n    echo $PROXY_PID > ../pids/proxy_server.pid\n    \n    # Attendre que le proxy dÃ©marre\n    sleep 3\n    \n    if curl -s http://localhost:8078 >/dev/null 2>&1; then\n        echo \"âœ… Proxy iframe dÃ©marrÃ© avec succÃ¨s (PID: $PROXY_PID)\"\n    else\n        echo \"âŒ Ã‰chec du dÃ©marrage du proxy\"\n    fi\nelse\n    echo \"âŒ Fichier proxy_server.js non trouvÃ©\"\nfi\n\n# 6. DÃ©marrer l'application mobile avec configuration optimisÃ©e\necho \"\"\necho \"ðŸ“± 6. DÃ©marrage de l'application mobile...\"\n\n# VÃ©rifier que server.js existe\nif [ -f \"server.js\" ]; then\n    # DÃ©marrer l'application mobile en arriÃ¨re-plan\n    node server.js > ../logs/mobile_app.log 2>&1 &\n    MOBILE_PID=$!\n    echo $MOBILE_PID > ../pids/mobile_app.pid\n    \n    # Attendre que l'application dÃ©marre\n    sleep 5\n    \n    if curl -s http://localhost:3005 >/dev/null 2>&1; then\n        echo \"âœ… Application mobile dÃ©marrÃ©e avec succÃ¨s (PID: $MOBILE_PID)\"\n    else\n        echo \"âŒ Ã‰chec du dÃ©marrage de l'application mobile\"\n    fi\nelse\n    echo \"âŒ Fichier server.js non trouvÃ©\"\nfi\n\ncd ..\n\n# 7. Tests de validation\necho \"\"\necho \"ðŸ§ª 7. Tests de validation...\"\n\n# Test de l'application mobile\necho \"Test application mobile:\"\nif curl -s -I http://localhost:3005 | grep -q \"200 OK\"; then\n    echo \"âœ… Application mobile: OK\"\nelse\n    echo \"âŒ Application mobile: ERREUR\"\nfi\n\n# Test du backend Odoo\necho \"Test backend Odoo:\"\nif curl -s -I http://localhost:8077 | grep -q -E \"(200|303)\"; then\n    echo \"âœ… Backend Odoo: OK\"\nelse\n    echo \"âŒ Backend Odoo: ERREUR\"\nfi\n\n# Test du proxy\necho \"Test proxy iframe:\"\nif curl -s -I http://localhost:8078 | grep -q -E \"(200|303)\"; then\n    echo \"âœ… Proxy iframe: OK\"\nelse\n    echo \"âŒ Proxy iframe: ERREUR\"\nfi\n\n# Test d'authentification\necho \"Test d'authentification:\"\nAUTH_RESPONSE=$(curl -s -X POST http://localhost:3005/api/mobile/auth/login \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\":\"admin\",\"password\":\"admin\"}' 2>/dev/null)\n\nif echo \"$AUTH_RESPONSE\" | grep -q '\"success\":true'; then\n    echo \"âœ… Authentification: SUCCÃˆS\"\n    TOKEN=$(echo \"$AUTH_RESPONSE\" | grep -o '\"token\":\"[^\"]*\"' | cut -d'\"' -f4)\n    echo \"   Token gÃ©nÃ©rÃ©: ${TOKEN:0:20}...\"\nelse\n    echo \"âŒ Authentification: Ã‰CHEC\"\n    echo \"   RÃ©ponse: $AUTH_RESPONSE\"\nfi\n\n# Test API Dashboard\nif [ ! -z \"$TOKEN\" ]; then\n    echo \"Test API Dashboard:\"\n    DASHBOARD_RESPONSE=$(curl -s http://localhost:3005/api/mobile/citizen/dashboard \\\n      -H \"Authorization: Bearer $TOKEN\" 2>/dev/null)\n    \n    if echo \"$DASHBOARD_RESPONSE\" | grep -q '\"success\":true'; then\n        echo \"âœ… API Dashboard: SUCCÃˆS\"\n        SOURCE=$(echo \"$DASHBOARD_RESPONSE\" | grep -o '\"source\":\"[^\"]*\"' | cut -d'\"' -f4)\n        echo \"   Source de donnÃ©es: $SOURCE\"\n    else\n        echo \"âŒ API Dashboard: Ã‰CHEC\"\n    fi\nfi\n\n# 8. RÃ©sumÃ© final\necho \"\"\necho \"ðŸ“‹ RÃ‰SUMÃ‰ FINAL\"\necho \"=\" | head -c 30; echo\n\n# VÃ©rifier l'Ã©tat final de tous les services\nALL_OK=true\n\nif ! curl -s http://localhost:3005 >/dev/null 2>&1; then\n    echo \"âŒ Application mobile (3005): NON ACCESSIBLE\"\n    ALL_OK=false\nelse\n    echo \"âœ… Application mobile (3005): ACCESSIBLE\"\nfi\n\nif ! curl -s http://localhost:8077 >/dev/null 2>&1; then\n    echo \"âŒ Backend Odoo (8077): NON ACCESSIBLE\"\n    ALL_OK=false\nelse\n    echo \"âœ… Backend Odoo (8077): ACCESSIBLE\"\nfi\n\nif ! curl -s http://localhost:8078 >/dev/null 2>&1; then\n    echo \"âŒ Proxy iframe (8078): NON ACCESSIBLE\"\n    ALL_OK=false\nelse\n    echo \"âœ… Proxy iframe (8078): ACCESSIBLE\"\nfi\n\necho \"\"\nif [ \"$ALL_OK\" = true ]; then\n    echo \"ðŸŽ‰ CORRECTION RÃ‰USSIE!\"\n    echo \"ðŸ“± Application mobile: http://localhost:3005\"\n    echo \"ðŸ›ï¸ Backend Odoo: http://localhost:8077\"\n    echo \"ðŸ”— Proxy iframe: http://localhost:8078\"\n    echo \"\"\n    echo \"ðŸ‘¤ Credentials: admin/admin\"\n    echo \"\"\n    echo \"âœ¨ L'application mobile devrait maintenant fonctionner correctement!\"\nelse\n    echo \"âš ï¸ CORRECTION PARTIELLE\"\n    echo \"Certains services ne rÃ©pondent pas correctement.\"\n    echo \"VÃ©rifiez les logs dans le dossier logs/\"\nfi\n\necho \"\"\necho \"ðŸ“Š Processus actifs:\"\nps aux | grep -E \"(node server.js|node proxy_server.js|python3 odoo-bin)\" | grep -v grep || echo \"Aucun processus SAMA CONAI trouvÃ©\"\n\necho \"\"\necho \"ðŸ“ Logs disponibles:\"\nls -la logs/ 2>/dev/null || echo \"Dossier logs non trouvÃ©\"\n\necho \"\"\necho \"ðŸ”§ Pour surveiller les logs en temps rÃ©el:\"\necho \"   tail -f logs/mobile_app.log\"\necho \"   tail -f logs/odoo.log\"\necho \"   tail -f logs/proxy_server.log\""