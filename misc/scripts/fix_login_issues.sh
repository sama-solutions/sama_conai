#!/bin/bash\n\n# Script de correction des problèmes de login et de boucle infinie\necho \"🔧 CORRECTION DES PROBLÈMES DE LOGIN SAMA CONAI\"\necho \"=\" | head -c 50; echo\n\n# 1. Vérifier l'état actuel\necho \"\"\necho \"📊 1. État actuel des services...\"\necho \"Application mobile (3005):\"\ncurl -s -I http://localhost:3005 | head -1 || echo \"❌ Non accessible\"\n\necho \"Backend Odoo (8077):\"\ncurl -s -I http://localhost:8077 | head -1 || echo \"❌ Non accessible\"\n\necho \"Proxy iframe (8078):\"\ncurl -s -I http://localhost:8078 | head -1 || echo \"❌ Non accessible\"\n\n# 2. Arrêter les processus problématiques\necho \"\"\necho \"⏹️ 2. Arrêt des processus existants...\"\npkill -f \"node server.js\" 2>/dev/null && echo \"✅ Serveur mobile arrêté\" || echo \"ℹ️ Serveur mobile déjà arrêté\"\npkill -f \"node proxy_server.js\" 2>/dev/null && echo \"✅ Proxy arrêté\" || echo \"ℹ️ Proxy déjà arrêté\"\n\n# Attendre que les processus se terminent\nsleep 3\n\n# 3. Nettoyer les fichiers temporaires\necho \"\"\necho \"🧹 3. Nettoyage des fichiers temporaires...\"\nrm -f pids/*.pid 2>/dev/null || true\nrm -f logs/mobile_app.log 2>/dev/null || true\nrm -f logs/proxy_server.log 2>/dev/null || true\necho \"✅ Fichiers temporaires nettoyés\"\n\n# 4. Vérifier la configuration Odoo\necho \"\"\necho \"🏛️ 4. Vérification de la configuration Odoo...\"\nif curl -s http://localhost:8077/web/login | grep -q \"oe_login_form\"; then\n    echo \"✅ Page de login Odoo accessible\"\n    \n    # Vérifier si le formulaire est masqué\n    if curl -s http://localhost:8077/web/login | grep -q \"d-none\"; then\n        echo \"⚠️ Formulaire de login masqué - Redémarrage d'Odoo nécessaire\"\n        \n        # Redémarrer Odoo si nécessaire\n        echo \"🔄 Redémarrage d'Odoo...\"\n        pkill -f \"python3 odoo-bin\" 2>/dev/null || true\n        sleep 5\n        \n        # Redémarrer Odoo en arrière-plan\n        python3 odoo-bin -c odoo_iframe_config.conf -d sama_conai_analytics \\\n          --addons-path=/var/odoo/odoo18/addons,/home/grand-as/psagsn/custom_addons \\\n          --http-port=8077 --log-level=info \\\n          --logfile=logs/odoo.log --pidfile=pids/odoo.pid &\n        \n        echo \"⏳ Attente du redémarrage d'Odoo...\"\n        for i in {1..30}; do\n            if curl -s http://localhost:8077 >/dev/null 2>&1; then\n                echo \"✅ Odoo redémarré avec succès\"\n                break\n            fi\n            echo \"   Tentative $i/30...\"\n            sleep 2\n        done\n    else\n        echo \"✅ Formulaire de login Odoo visible\"\n    fi\nelse\n    echo \"❌ Page de login Odoo inaccessible\"\n    echo \"🔄 Redémarrage d'Odoo nécessaire...\"\n    \n    # Forcer le redémarrage d'Odoo\n    pkill -f \"python3 odoo-bin\" 2>/dev/null || true\n    sleep 5\n    \n    python3 odoo-bin -c odoo_iframe_config.conf -d sama_conai_analytics \\\n      --addons-path=/var/odoo/odoo18/addons,/home/grand-as/psagsn/custom_addons \\\n      --http-port=8077 --log-level=info \\\n      --logfile=logs/odoo.log --pidfile=pids/odoo.pid &\n    \n    echo \"⏳ Attente du démarrage d'Odoo...\"\n    for i in {1..30}; do\n        if curl -s http://localhost:8077 >/dev/null 2>&1; then\n            echo \"✅ Odoo démarré avec succès\"\n            break\n        fi\n        echo \"   Tentative $i/30...\"\n        sleep 2\n    done\nfi\n\n# 5. Démarrer le proxy avec configuration corrigée\necho \"\"\necho \"🔗 5. Démarrage du proxy iframe...\"\ncd mobile_app_web\n\n# Vérifier que proxy_server.js existe et est configuré\nif [ -f \"proxy_server.js\" ]; then\n    # Démarrer le proxy en arrière-plan\n    node proxy_server.js > ../logs/proxy_server.log 2>&1 &\n    PROXY_PID=$!\n    echo $PROXY_PID > ../pids/proxy_server.pid\n    \n    # Attendre que le proxy démarre\n    sleep 3\n    \n    if curl -s http://localhost:8078 >/dev/null 2>&1; then\n        echo \"✅ Proxy iframe démarré avec succès (PID: $PROXY_PID)\"\n    else\n        echo \"❌ Échec du démarrage du proxy\"\n    fi\nelse\n    echo \"❌ Fichier proxy_server.js non trouvé\"\nfi\n\n# 6. Démarrer l'application mobile avec configuration optimisée\necho \"\"\necho \"📱 6. Démarrage de l'application mobile...\"\n\n# Vérifier que server.js existe\nif [ -f \"server.js\" ]; then\n    # Démarrer l'application mobile en arrière-plan\n    node server.js > ../logs/mobile_app.log 2>&1 &\n    MOBILE_PID=$!\n    echo $MOBILE_PID > ../pids/mobile_app.pid\n    \n    # Attendre que l'application démarre\n    sleep 5\n    \n    if curl -s http://localhost:3005 >/dev/null 2>&1; then\n        echo \"✅ Application mobile démarrée avec succès (PID: $MOBILE_PID)\"\n    else\n        echo \"❌ Échec du démarrage de l'application mobile\"\n    fi\nelse\n    echo \"❌ Fichier server.js non trouvé\"\nfi\n\ncd ..\n\n# 7. Tests de validation\necho \"\"\necho \"🧪 7. Tests de validation...\"\n\n# Test de l'application mobile\necho \"Test application mobile:\"\nif curl -s -I http://localhost:3005 | grep -q \"200 OK\"; then\n    echo \"✅ Application mobile: OK\"\nelse\n    echo \"❌ Application mobile: ERREUR\"\nfi\n\n# Test du backend Odoo\necho \"Test backend Odoo:\"\nif curl -s -I http://localhost:8077 | grep -q -E \"(200|303)\"; then\n    echo \"✅ Backend Odoo: OK\"\nelse\n    echo \"❌ Backend Odoo: ERREUR\"\nfi\n\n# Test du proxy\necho \"Test proxy iframe:\"\nif curl -s -I http://localhost:8078 | grep -q -E \"(200|303)\"; then\n    echo \"✅ Proxy iframe: OK\"\nelse\n    echo \"❌ Proxy iframe: ERREUR\"\nfi\n\n# Test d'authentification\necho \"Test d'authentification:\"\nAUTH_RESPONSE=$(curl -s -X POST http://localhost:3005/api/mobile/auth/login \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\":\"admin\",\"password\":\"admin\"}' 2>/dev/null)\n\nif echo \"$AUTH_RESPONSE\" | grep -q '\"success\":true'; then\n    echo \"✅ Authentification: SUCCÈS\"\n    TOKEN=$(echo \"$AUTH_RESPONSE\" | grep -o '\"token\":\"[^\"]*\"' | cut -d'\"' -f4)\n    echo \"   Token généré: ${TOKEN:0:20}...\"\nelse\n    echo \"❌ Authentification: ÉCHEC\"\n    echo \"   Réponse: $AUTH_RESPONSE\"\nfi\n\n# Test API Dashboard\nif [ ! -z \"$TOKEN\" ]; then\n    echo \"Test API Dashboard:\"\n    DASHBOARD_RESPONSE=$(curl -s http://localhost:3005/api/mobile/citizen/dashboard \\\n      -H \"Authorization: Bearer $TOKEN\" 2>/dev/null)\n    \n    if echo \"$DASHBOARD_RESPONSE\" | grep -q '\"success\":true'; then\n        echo \"✅ API Dashboard: SUCCÈS\"\n        SOURCE=$(echo \"$DASHBOARD_RESPONSE\" | grep -o '\"source\":\"[^\"]*\"' | cut -d'\"' -f4)\n        echo \"   Source de données: $SOURCE\"\n    else\n        echo \"❌ API Dashboard: ÉCHEC\"\n    fi\nfi\n\n# 8. Résumé final\necho \"\"\necho \"📋 RÉSUMÉ FINAL\"\necho \"=\" | head -c 30; echo\n\n# Vérifier l'état final de tous les services\nALL_OK=true\n\nif ! curl -s http://localhost:3005 >/dev/null 2>&1; then\n    echo \"❌ Application mobile (3005): NON ACCESSIBLE\"\n    ALL_OK=false\nelse\n    echo \"✅ Application mobile (3005): ACCESSIBLE\"\nfi\n\nif ! curl -s http://localhost:8077 >/dev/null 2>&1; then\n    echo \"❌ Backend Odoo (8077): NON ACCESSIBLE\"\n    ALL_OK=false\nelse\n    echo \"✅ Backend Odoo (8077): ACCESSIBLE\"\nfi\n\nif ! curl -s http://localhost:8078 >/dev/null 2>&1; then\n    echo \"❌ Proxy iframe (8078): NON ACCESSIBLE\"\n    ALL_OK=false\nelse\n    echo \"✅ Proxy iframe (8078): ACCESSIBLE\"\nfi\n\necho \"\"\nif [ \"$ALL_OK\" = true ]; then\n    echo \"🎉 CORRECTION RÉUSSIE!\"\n    echo \"📱 Application mobile: http://localhost:3005\"\n    echo \"🏛️ Backend Odoo: http://localhost:8077\"\n    echo \"🔗 Proxy iframe: http://localhost:8078\"\n    echo \"\"\n    echo \"👤 Credentials: admin/admin\"\n    echo \"\"\n    echo \"✨ L'application mobile devrait maintenant fonctionner correctement!\"\nelse\n    echo \"⚠️ CORRECTION PARTIELLE\"\n    echo \"Certains services ne répondent pas correctement.\"\n    echo \"Vérifiez les logs dans le dossier logs/\"\nfi\n\necho \"\"\necho \"📊 Processus actifs:\"\nps aux | grep -E \"(node server.js|node proxy_server.js|python3 odoo-bin)\" | grep -v grep || echo \"Aucun processus SAMA CONAI trouvé\"\n\necho \"\"\necho \"📁 Logs disponibles:\"\nls -la logs/ 2>/dev/null || echo \"Dossier logs non trouvé\"\n\necho \"\"\necho \"🔧 Pour surveiller les logs en temps réel:\"\necho \"   tail -f logs/mobile_app.log\"\necho \"   tail -f logs/odoo.log\"\necho \"   tail -f logs/proxy_server.log\""