#!/bin/bash\n\n# =============================================================================\n# SCRIPT DE D√âMARRAGE STACK SAMA CONAI\n# D√©marre et v√©rifie tous les services n√©cessaires\n# =============================================================================\n\nset -e\n\n# Couleurs pour l'affichage\nRED='\\033[0;31m'\nGREEN='\\033[0;32m'\nYELLOW='\\033[1;33m'\nBLUE='\\033[0;34m'\nNC='\\033[0m' # No Color\n\n# Configuration\nPROJECT_DIR=\"/home/grand-as/psagsn/custom_addons/sama_conai\"\nLOGS_DIR=\"$PROJECT_DIR/logs\"\nPIDS_DIR=\"$PROJECT_DIR/pids\"\n\n# Fonction d'affichage\nprint_header() {\n    echo -e \"${BLUE}==============================================================================${NC}\"\n    echo -e \"${BLUE}üöÄ D√âMARRAGE STACK SAMA CONAI${NC}\"\n    echo -e \"${BLUE}==============================================================================${NC}\"\n}\n\nprint_status() {\n    echo -e \"${GREEN}‚úÖ $1${NC}\"\n}\n\nprint_warning() {\n    echo -e \"${YELLOW}‚ö†Ô∏è  $1${NC}\"\n}\n\nprint_error() {\n    echo -e \"${RED}‚ùå $1${NC}\"\n}\n\nprint_info() {\n    echo -e \"${BLUE}‚ÑπÔ∏è  $1${NC}\"\n}\n\n# Fonction de v√©rification des ports\ncheck_port() {\n    local port=$1\n    local service=$2\n    \n    if netstat -tlnp 2>/dev/null | grep -q \":$port \"; then\n        print_status \"$service (port $port) - ACTIF\"\n        return 0\n    else\n        print_warning \"$service (port $port) - INACTIF\"\n        return 1\n    fi\n}\n\n# Fonction de test HTTP\ntest_http_service() {\n    local url=$1\n    local service=$2\n    \n    local http_code=$(curl -s -o /dev/null -w \"%{http_code}\" \"$url\" 2>/dev/null || echo \"000\")\n    \n    if [[ \"$http_code\" =~ ^(200|303|302)$ ]]; then\n        print_status \"$service - R√âPONDANT (HTTP $http_code)\"\n        return 0\n    else\n        print_error \"$service - NON R√âPONDANT (HTTP $http_code)\"\n        return 1\n    fi\n}\n\n# Fonction de d√©marrage des services\nstart_service() {\n    local service_name=$1\n    local start_command=$2\n    local port=$3\n    local max_wait=${4:-30}\n    \n    print_info \"D√©marrage de $service_name...\"\n    \n    # Ex√©cuter la commande de d√©marrage\n    eval \"$start_command\" &\n    local pid=$!\n    \n    # Attendre que le service soit pr√™t\n    local count=0\n    while [ $count -lt $max_wait ]; do\n        if check_port $port \"$service_name\" >/dev/null 2>&1; then\n            print_status \"$service_name d√©marr√© avec succ√®s (PID: $pid)\"\n            return 0\n        fi\n        sleep 1\n        ((count++))\n    done\n    \n    print_error \"√âchec du d√©marrage de $service_name apr√®s ${max_wait}s\"\n    return 1\n}\n\n# Fonction principale\nmain() {\n    print_header\n    \n    # Cr√©er les r√©pertoires n√©cessaires\n    print_info \"Cr√©ation des r√©pertoires...\"\n    mkdir -p \"$LOGS_DIR\" \"$PIDS_DIR\"\n    \n    # Aller dans le r√©pertoire du projet\n    cd \"$PROJECT_DIR\"\n    \n    print_info \"V√©rification de l'√©tat actuel des services...\"\n    echo\n    \n    # V√©rifier les services de base\n    echo -e \"${BLUE}üìä SERVICES DE BASE:${NC}\"\n    check_port 5432 \"PostgreSQL\"\n    check_port 3306 \"MySQL\"\n    echo\n    \n    # V√©rifier les services SAMA CONAI\n    echo -e \"${BLUE}üèõÔ∏è SERVICES SAMA CONAI:${NC}\"\n    odoo_running=$(check_port 8077 \"Odoo Backend\")\n    mobile_running=$(check_port 3005 \"Application Mobile\")\n    proxy_running=$(check_port 8078 \"Proxy Server\")\n    echo\n    \n    # Tester la connectivit√© HTTP\n    echo -e \"${BLUE}üåê TESTS DE CONNECTIVIT√â:${NC}\"\n    \n    if [ $odoo_running ]; then\n        test_http_service \"http://localhost:8077\" \"Odoo Backend\"\n    fi\n    \n    if [ $mobile_running ]; then\n        test_http_service \"http://localhost:3005\" \"Application Mobile\"\n    fi\n    \n    if [ $proxy_running ]; then\n        test_http_service \"http://localhost:8078\" \"Proxy Server\"\n    fi\n    \n    echo\n    \n    # D√©marrer les services manquants\n    services_started=0\n    \n    if ! check_port 8077 \"Odoo\" >/dev/null 2>&1; then\n        print_info \"D√©marrage d'Odoo...\"\n        cd \"$PROJECT_DIR\"\n        nohup python3 odoo-bin -c odoo_iframe_config.conf -d sama_conai_analytics \\\n            --addons-path=/var/odoo/odoo18/addons,/home/grand-as/psagsn/custom_addons \\\n            --http-port=8077 --log-level=info \\\n            --logfile=\"$LOGS_DIR/odoo.log\" \\\n            --pidfile=\"$PIDS_DIR/odoo.pid\" > \"$LOGS_DIR/odoo_startup.log\" 2>&1 &\n        \n        # Attendre qu'Odoo soit pr√™t\n        print_info \"Attente du d√©marrage d'Odoo (peut prendre 30-60 secondes)...\"\n        sleep 10\n        \n        local count=0\n        while [ $count -lt 60 ]; do\n            if check_port 8077 \"Odoo\" >/dev/null 2>&1; then\n                print_status \"Odoo d√©marr√© avec succ√®s\"\n                services_started=$((services_started + 1))\n                break\n            fi\n            sleep 2\n            ((count += 2))\n            if [ $((count % 10)) -eq 0 ]; then\n                print_info \"Attente d'Odoo... (${count}s)\"\n            fi\n        done\n        \n        if [ $count -ge 60 ]; then\n            print_error \"√âchec du d√©marrage d'Odoo apr√®s 60s\"\n        fi\n    fi\n    \n    if ! check_port 3005 \"Application Mobile\" >/dev/null 2>&1; then\n        print_info \"D√©marrage de l'Application Mobile...\"\n        cd \"$PROJECT_DIR/mobile_app_web\"\n        nohup node server.js > \"$LOGS_DIR/mobile_app.log\" 2>&1 &\n        echo $! > \"$PIDS_DIR/mobile_app.pid\"\n        \n        sleep 5\n        if check_port 3005 \"Application Mobile\" >/dev/null 2>&1; then\n            print_status \"Application Mobile d√©marr√©e avec succ√®s\"\n            services_started=$((services_started + 1))\n        else\n            print_error \"√âchec du d√©marrage de l'Application Mobile\"\n        fi\n    fi\n    \n    if ! check_port 8078 \"Proxy Server\" >/dev/null 2>&1; then\n        print_info \"D√©marrage du Proxy Server...\"\n        cd \"$PROJECT_DIR\"\n        nohup node proxy_server.js > \"$LOGS_DIR/proxy_server.log\" 2>&1 &\n        echo $! > \"$PIDS_DIR/proxy_server.pid\"\n        \n        sleep 3\n        if check_port 8078 \"Proxy Server\" >/dev/null 2>&1; then\n            print_status \"Proxy Server d√©marr√© avec succ√®s\"\n            services_started=$((services_started + 1))\n        else\n            print_error \"√âchec du d√©marrage du Proxy Server\"\n        fi\n    fi\n    \n    echo\n    echo -e \"${BLUE}==============================================================================${NC}\"\n    echo -e \"${GREEN}üìä R√âSUM√â DU D√âMARRAGE${NC}\"\n    echo -e \"${BLUE}==============================================================================${NC}\"\n    \n    # V√©rification finale\n    echo -e \"${BLUE}üîç √âTAT FINAL DES SERVICES:${NC}\"\n    \n    local all_services_ok=true\n    \n    if check_port 8077 \"Odoo Backend\" && test_http_service \"http://localhost:8077\" \"Odoo\" >/dev/null 2>&1; then\n        print_status \"‚úÖ Odoo Backend - OP√âRATIONNEL\"\n    else\n        print_error \"‚ùå Odoo Backend - PROBL√àME\"\n        all_services_ok=false\n    fi\n    \n    if check_port 3005 \"Application Mobile\" && test_http_service \"http://localhost:3005\" \"Mobile App\" >/dev/null 2>&1; then\n        print_status \"‚úÖ Application Mobile - OP√âRATIONNELLE\"\n    else\n        print_error \"‚ùå Application Mobile - PROBL√àME\"\n        all_services_ok=false\n    fi\n    \n    if check_port 8078 \"Proxy Server\" && test_http_service \"http://localhost:8078\" \"Proxy\" >/dev/null 2>&1; then\n        print_status \"‚úÖ Proxy Server - OP√âRATIONNEL\"\n    else\n        print_error \"‚ùå Proxy Server - PROBL√àME\"\n        all_services_ok=false\n    fi\n    \n    echo\n    \n    if [ \"$all_services_ok\" = true ]; then\n        echo -e \"${GREEN}üéâ STACK SAMA CONAI ENTI√àREMENT OP√âRATIONNEL !${NC}\"\n        echo\n        echo -e \"${BLUE}üåê URLS D'ACC√àS:${NC}\"\n        echo -e \"   üì± Application Mobile: ${GREEN}http://localhost:3005${NC}\"\n        echo -e \"   üèõÔ∏è  Backend Odoo:      ${GREEN}http://localhost:8077${NC}\"\n        echo -e \"   üîó Proxy Iframe:      ${GREEN}http://localhost:8078${NC}\"\n        echo\n        echo -e \"${BLUE}üìä OPTIMISATIONS ACTIVES:${NC}\"\n        echo -e \"   ‚ö° Cache intelligent avec synchronisation hors ligne\"\n        echo -e \"   üìä Moniteur de performance temps r√©el\"\n        echo -e \"   üîß Service Worker pour cache avanc√©\"\n        echo -e \"   üîÑ Synchronisation automatique des donn√©es\"\n        echo\n        echo -e \"${BLUE}üîß COMMANDES UTILES:${NC}\"\n        echo -e \"   ‚Ä¢ Arr√™ter le stack: ${YELLOW}./stop_sama_conai_stack.sh${NC}\"\n        echo -e \"   ‚Ä¢ Voir les logs: ${YELLOW}tail -f logs/*.log${NC}\"\n        echo -e \"   ‚Ä¢ Red√©marrer: ${YELLOW}./restart_sama_conai_stack.sh${NC}\"\n        \n    else\n        echo -e \"${RED}‚ö†Ô∏è  CERTAINS SERVICES ONT DES PROBL√àMES${NC}\"\n        echo\n        echo -e \"${BLUE}üîß D√âPANNAGE:${NC}\"\n        echo -e \"   ‚Ä¢ V√©rifier les logs: ${YELLOW}tail -f logs/*.log${NC}\"\n        echo -e \"   ‚Ä¢ V√©rifier les ports: ${YELLOW}netstat -tlnp${NC}\"\n        echo -e \"   ‚Ä¢ Red√©marrer les services: ${YELLOW}./restart_sama_conai_stack.sh${NC}\"\n    fi\n    \n    echo\n    echo -e \"${BLUE}üìÅ FICHIERS DE LOGS:${NC}\"\n    echo -e \"   ‚Ä¢ Odoo: ${YELLOW}$LOGS_DIR/odoo.log${NC}\"\n    echo -e \"   ‚Ä¢ Mobile App: ${YELLOW}$LOGS_DIR/mobile_app.log${NC}\"\n    echo -e \"   ‚Ä¢ Proxy: ${YELLOW}$LOGS_DIR/proxy_server.log${NC}\"\n    \n    echo\n    echo -e \"${BLUE}==============================================================================${NC}\"\n    \n    if [ \"$services_started\" -gt 0 ]; then\n        print_info \"$services_started nouveau(x) service(s) d√©marr√©(s)\"\n    else\n        print_info \"Tous les services √©taient d√©j√† en cours d'ex√©cution\"\n    fi\n    \n    return 0\n}\n\n# Gestion des signaux\ntrap 'echo -e \"\\n${RED}Interruption d√©tect√©e. Arr√™t...${NC}\"; exit 1' INT TERM\n\n# V√©rifier si on est dans le bon r√©pertoire\nif [ ! -f \"odoo-bin\" ]; then\n    print_error \"Ce script doit √™tre ex√©cut√© depuis le r√©pertoire SAMA CONAI\"\n    print_info \"Changement vers: $PROJECT_DIR\"\n    cd \"$PROJECT_DIR\"\nfi\n\n# Ex√©cuter la fonction principale\nmain \"$@\"\n"