// Serveur SAMA CONAI UX avec int√©gration Odoo XML-RPC compl√®te
const http = require('http');
const fs = require('fs');
const path = require('path');
const url = require('url');

// Import du connecteur Odoo XML-RPC
const OdooXMLRPCConnector = require('./odoo_xmlrpc_connector.js');

const PORT = process.env.PORT || 3004;

// Configuration Odoo
const ODOO_CONFIG = {
    url: process.env.ODOO_URL || 'http://localhost:8077',
    database: process.env.ODOO_DB || 'sama_conai_analytics',
    username: process.env.ODOO_USER || 'admin',
    password: process.env.ODOO_PASSWORD || 'admin'
};

// Instance du connecteur Odoo
let odooConnector = null;
let isOdooConnected = false;

// Donn√©es de fallback enrichies (utilis√©es si Odoo n'est pas disponible)
const FALLBACK_DATA = {
    stats: {
        totalRequests: 47,
        pendingRequests: 12,
        completedRequests: 35,
        totalAlerts: 23,
        activeAlerts: 8,
        satisfactionRate: 89,
        averageResponseTime: 16.8
    },
    recentRequests: [
        {
            id: 1,
            name: 'REQ-2024-001',
            description: 'Demande d\'acc√®s aux documents budg√©taires 2024',
            status: 'in_progress',
            date: '2024-09-05',
            requester: 'Amadou Diallo'
        },
        {
            id: 2,
            name: 'REQ-2024-002',
            description: 'Information sur les march√©s publics en cours',
            status: 'pending_validation',
            date: '2024-09-04',
            requester: 'Fatou Sall'
        }
    ],
    recentAlerts: [
        {
            id: 1,
            name: 'ALERT-2024-001',
            description: 'Suspicion de d√©tournement de fonds publics',
            category: 'corruption',
            priority: 'urgent',
            status: 'investigation',
            date: '2024-09-06'
        }
    ]
};

// Initialisation du connecteur Odoo
async function initializeOdooConnector() {
    try {
        console.log('üîÑ Initialisation du connecteur Odoo XML-RPC...');
        
        odooConnector = new OdooXMLRPCConnector(ODOO_CONFIG);
        isOdooConnected = await odooConnector.authenticate();
        
        if (isOdooConnected) {
            console.log('‚úÖ Connexion Odoo √©tablie avec succ√®s');
        } else {
            console.log('‚ö†Ô∏è Connexion Odoo √©chou√©e, utilisation du mode fallback');
        }
    } catch (error) {
        console.error('‚ùå Erreur initialisation Odoo:', error.message);
        isOdooConnected = false;
    }
}

// Fonction pour servir les fichiers statiques
function serveStaticFile(res, filePath, contentType) {
    fs.readFile(filePath, (err, content) => {
        if (err) {
            res.writeHead(404, { 'Content-Type': 'text/plain' });
            res.end('Fichier non trouv√©');
        } else {
            res.writeHead(200, { 'Content-Type': contentType });
            res.end(content);
        }
    });
}

// Fonction pour envoyer une r√©ponse JSON
function sendJsonResponse(res, data, statusCode = 200) {
    res.writeHead(statusCode, {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
        'Access-Control-Allow-Headers': 'Content-Type, Authorization'
    });
    res.end(JSON.stringify(data));
}

// Gestionnaire pour les requ√™tes OPTIONS (CORS)
function handleCors(res) {
    res.writeHead(200, {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
        'Access-Control-Allow-Headers': 'Content-Type, Authorization'
    });
    res.end();
}

// API Endpoints

// Authentification
async function handleAuth(req, res) {
    if (req.method === 'POST') {
        let body = '';
        req.on('data', chunk => body += chunk);
        req.on('end', () => {
            try {
                const { email, password } = JSON.parse(body);
                
                // Comptes de test
                const testAccounts = {
                    'admin@sama-conai.sn': { password: 'admin123', role: 'admin', name: 'Administrateur SAMA CONAI' },
                    'agent@sama-conai.sn': { password: 'agent123', role: 'agent', name: 'Agent Transparence' },
                    'citoyen@email.com': { password: 'citoyen123', role: 'citizen', name: 'Citoyen S√©n√©galais' }
                };

                const account = testAccounts[email];
                if (account && account.password === password) {
                    sendJsonResponse(res, {
                        success: true,
                        user: {
                            email: email,
                            name: account.name,
                            role: account.role
                        },
                        token: 'fake-jwt-token-' + Date.now()
                    });
                } else {
                    sendJsonResponse(res, {
                        success: false,
                        message: 'Identifiants incorrects'
                    }, 401);
                }
            } catch (error) {
                sendJsonResponse(res, {
                    success: false,
                    message: 'Erreur de traitement'
                }, 400);
            }
        });
    } else {
        sendJsonResponse(res, { message: 'M√©thode non autoris√©e' }, 405);
    }
}

// Dashboard avec donn√©es Odoo ou fallback
async function handleDashboard(req, res) {
    try {
        let dashboardData;
        
        if (isOdooConnected && odooConnector) {
            console.log('üìä R√©cup√©ration des donn√©es dashboard depuis Odoo...');
            dashboardData = await odooConnector.getDashboardStats();
        } else {
            console.log('üìä Utilisation des donn√©es de fallback...');
            dashboardData = FALLBACK_DATA;
        }
        
        sendJsonResponse(res, {
            success: true,
            data: dashboardData,
            source: isOdooConnected ? 'odoo' : 'fallback',
            timestamp: new Date().toISOString()
        });
    } catch (error) {
        console.error('‚ùå Erreur dashboard:', error.message);
        sendJsonResponse(res, {
            success: true,
            data: FALLBACK_DATA,
            source: 'fallback',
            error: error.message,
            timestamp: new Date().toISOString()
        });
    }
}

// Demandes d'information
async function handleRequests(req, res) {
    const urlParts = req.url.split('/');
    const requestId = urlParts[3]; // /api/requests/:id

    try {
        if (requestId && requestId !== '') {
            // R√©cup√©rer une demande sp√©cifique
            let requestData;
            
            if (isOdooConnected && odooConnector) {
                console.log(`üìÑ R√©cup√©ration de la demande ${requestId} depuis Odoo...`);
                requestData = await odooConnector.getInformationRequest(parseInt(requestId));
            } else {
                // Donn√©es de fallback pour une demande sp√©cifique
                requestData = {
                    id: parseInt(requestId),
                    name: `REQ-2024-${requestId.padStart(3, '0')}`,
                    description: 'Demande d\'acc√®s aux documents budg√©taires 2024',
                    requester: 'Amadou Diallo',
                    requesterEmail: 'amadou.diallo@email.com',
                    status: 'in_progress',
                    date: '2024-09-05',
                    deadline: '2024-09-20',
                    assignedTo: 'Agent Transparence',
                    department: 'Minist√®re des Finances',
                    history: [
                        {
                            date: '2024-09-05',
                            action: 'Demande soumise',
                            user: 'Amadou Diallo',
                            comment: 'Demande initiale d√©pos√©e'
                        }
                    ]
                };
            }
            
            if (requestData) {
                sendJsonResponse(res, {
                    success: true,
                    data: requestData,
                    source: isOdooConnected ? 'odoo' : 'fallback'
                });
            } else {
                sendJsonResponse(res, {
                    success: false,
                    message: 'Demande non trouv√©e'
                }, 404);
            }
        } else {
            // R√©cup√©rer toutes les demandes
            let requestsData;
            
            if (isOdooConnected && odooConnector) {
                console.log('üìÑ R√©cup√©ration des demandes depuis Odoo...');
                requestsData = await odooConnector.getInformationRequests({ limit: 50 });
            } else {
                // Donn√©es de fallback
                requestsData = {
                    requests: [
                        {
                            id: 1,
                            name: 'REQ-2024-001',
                            description: 'Demande d\'acc√®s aux documents budg√©taires 2024',
                            requester: 'Amadou Diallo',
                            status: 'in_progress',
                            date: '2024-09-05'
                        },
                        {
                            id: 2,
                            name: 'REQ-2024-002',
                            description: 'Information sur les march√©s publics en cours',
                            requester: 'Fatou Sall',
                            status: 'pending_validation',
                            date: '2024-09-04'
                        }
                    ],
                    pagination: { page: 1, total: 2, pages: 1 }
                };
            }
            
            sendJsonResponse(res, {
                success: true,
                data: requestsData,
                source: isOdooConnected ? 'odoo' : 'fallback'
            });
        }
    } catch (error) {
        console.error('‚ùå Erreur requests:', error.message);
        sendJsonResponse(res, {
            success: false,
            message: 'Erreur lors de la r√©cup√©ration des demandes',
            error: error.message
        }, 500);
    }
}

// Alertes
async function handleAlerts(req, res) {
    const urlParts = req.url.split('/');
    const alertId = urlParts[3]; // /api/alerts/:id

    try {
        if (alertId && alertId !== '') {
            // R√©cup√©rer une alerte sp√©cifique
            let alertData;
            
            if (isOdooConnected && odooConnector) {
                console.log(`üö® R√©cup√©ration de l'alerte ${alertId} depuis Odoo...`);
                alertData = await odooConnector.getWhistleblowingAlert(parseInt(alertId));
            } else {
                // Donn√©es de fallback pour une alerte sp√©cifique
                alertData = {
                    id: parseInt(alertId),
                    name: `ALERT-2024-${alertId.padStart(3, '0')}`,
                    description: 'Suspicion de d√©tournement de fonds publics',
                    category: 'corruption',
                    priority: 'urgent',
                    status: 'investigation',
                    date: '2024-09-06',
                    assignedTo: 'Enqu√™teur Principal',
                    reportedBy: 'Anonyme',
                    location: 'Dakar, S√©n√©gal',
                    estimatedAmount: '2.5 milliards FCFA',
                    confidentialityLevel: 'Maximum',
                    evidence: ['Documents photographi√©s', 'T√©moignages audio'],
                    history: [
                        {
                            date: '2024-09-06',
                            action: 'Signalement re√ßu',
                            user: 'Syst√®me',
                            comment: 'Alerte soumise via canal s√©curis√©'
                        }
                    ]
                };
            }
            
            if (alertData) {
                sendJsonResponse(res, {
                    success: true,
                    data: alertData,
                    source: isOdooConnected ? 'odoo' : 'fallback'
                });
            } else {
                sendJsonResponse(res, {
                    success: false,
                    message: 'Alerte non trouv√©e'
                }, 404);
            }
        } else {
            // R√©cup√©rer toutes les alertes
            let alertsData;
            
            if (isOdooConnected && odooConnector) {
                console.log('üö® R√©cup√©ration des alertes depuis Odoo...');
                alertsData = await odooConnector.getWhistleblowingAlerts({ limit: 50 });
            } else {
                // Donn√©es de fallback
                alertsData = {
                    alerts: [
                        {
                            id: 1,
                            name: 'ALERT-2024-001',
                            description: 'Suspicion de d√©tournement de fonds publics',
                            category: 'corruption',
                            priority: 'urgent',
                            status: 'investigation',
                            date: '2024-09-06'
                        },
                        {
                            id: 2,
                            name: 'ALERT-2024-002',
                            description: 'Irr√©gularit√©s dans l\'attribution des march√©s',
                            category: 'fraud',
                            priority: 'high',
                            status: 'preliminary_assessment',
                            date: '2024-09-05'
                        }
                    ],
                    pagination: { page: 1, total: 2, pages: 1 }
                };
            }
            
            sendJsonResponse(res, {
                success: true,
                data: alertsData,
                source: isOdooConnected ? 'odoo' : 'fallback'
            });
        }
    } catch (error) {
        console.error('‚ùå Erreur alerts:', error.message);
        sendJsonResponse(res, {
            success: false,
            message: 'Erreur lors de la r√©cup√©ration des alertes',
            error: error.message
        }, 500);
    }
}

// Test de connexion Odoo
async function handleTestOdoo(req, res) {
    try {
        if (isOdooConnected && odooConnector) {
            // Test de connexion en r√©cup√©rant quelques donn√©es
            const testCount = await odooConnector.searchCount('request.information');
            sendJsonResponse(res, {
                success: true,
                connected: true,
                message: 'Connexion Odoo active',
                config: {
                    url: ODOO_CONFIG.url,
                    database: ODOO_CONFIG.database,
                    user: ODOO_CONFIG.username
                },
                testData: {
                    requestCount: testCount
                }
            });
        } else {
            sendJsonResponse(res, {
                success: false,
                connected: false,
                message: 'Connexion Odoo non disponible',
                config: {
                    url: ODOO_CONFIG.url,
                    database: ODOO_CONFIG.database,
                    user: ODOO_CONFIG.username
                }
            });
        }
    } catch (error) {
        sendJsonResponse(res, {
            success: false,
            connected: false,
            message: 'Erreur de test Odoo',
            error: error.message
        });
    }
}

// Serveur HTTP principal
async function startServer() {
    // Initialiser la connexion Odoo
    await initializeOdooConnector();
    
    const server = http.createServer((req, res) => {
        const parsedUrl = url.parse(req.url, true);
        const pathname = parsedUrl.pathname;

        // Gestion CORS
        if (req.method === 'OPTIONS') {
            handleCors(res);
            return;
        }

        // Routes API
        if (pathname.startsWith('/api/')) {
            if (pathname === '/api/auth/login') {
                handleAuth(req, res);
            } else if (pathname === '/api/dashboard') {
                handleDashboard(req, res);
            } else if (pathname.startsWith('/api/requests')) {
                handleRequests(req, res);
            } else if (pathname.startsWith('/api/alerts')) {
                handleAlerts(req, res);
            } else if (pathname === '/api/test-odoo') {
                handleTestOdoo(req, res);
            } else {
                sendJsonResponse(res, { message: 'Endpoint non trouv√©' }, 404);
            }
            return;
        }

        // Fichiers statiques
        let filePath = path.join(__dirname, 'public', pathname === '/' ? 'index.html' : pathname);
        
        // D√©terminer le type de contenu
        const ext = path.extname(filePath);
        let contentType = 'text/html';
        
        switch (ext) {
            case '.css': contentType = 'text/css'; break;
            case '.js': contentType = 'application/javascript'; break;
            case '.json': contentType = 'application/json'; break;
            case '.png': contentType = 'image/png'; break;
            case '.jpg': contentType = 'image/jpeg'; break;
            case '.svg': contentType = 'image/svg+xml'; break;
        }

        serveStaticFile(res, filePath, contentType);
    });

    server.listen(PORT, () => {
        console.log('\nüé® SAMA CONAI UX R√âVOLUTIONNAIRE v6.0 - SERVEUR AVEC INT√âGRATION ODOO COMPL√àTE');
        console.log('='.repeat(80));
        console.log('');
        console.log('üåê URL: http://localhost:' + PORT);
        console.log('üéØ Design: UX Inspir√© des Meilleurs Designs');
        console.log('üì± Interface: Mobile-First R√©volutionnaire avec Drilldown');
        console.log('‚ú® Animations: Micro-interactions Fluides');
        console.log('üé® Th√®me: Design System Moderne');
        console.log('üöÄ Performance: Optimis√©e pour Mobile');
        console.log(`üìä Donn√©es: ${isOdooConnected ? '‚úÖ ODOO CONNECT√â' : '‚ö†Ô∏è FALLBACK MODE'}`);
        console.log('');
        console.log('üîß CONFIGURATION ODOO:');
        console.log(`   üåê URL: ${ODOO_CONFIG.url}`);
        console.log(`   üóÑÔ∏è Base: ${ODOO_CONFIG.database}`);
        console.log(`   üë§ User: ${ODOO_CONFIG.username}`);
        console.log(`   üîó Status: ${isOdooConnected ? 'CONNECT√â' : 'D√âCONNECT√â'}`);
        console.log('');
        console.log('üîë COMPTES DE TEST:');
        console.log('   üëë Admin: admin@sama-conai.sn / admin123');
        console.log('   üõ°Ô∏è Agent: agent@sama-conai.sn / agent123');
        console.log('   üë§ Citoyen: citoyen@email.com / citoyen123');
        console.log('');
        console.log('üéâ FONCTIONNALIT√âS R√âVOLUTIONNAIRES:');
        console.log('   ‚ú® Glassmorphism et Neumorphism');
        console.log('   üé≠ Micro-interactions avanc√©es');
        console.log('   üåä Animations fluides 60fps');
        console.log('   üé® Design system sophistiqu√©');
        console.log('   üì± Navigation gestuelle avec drilldown');
        console.log('   üåô Mode sombre √©l√©gant');
        console.log('   üéØ Transitions seamless');
        console.log(`   üìä ${isOdooConnected ? 'Donn√©es Odoo r√©elles' : 'Donn√©es simul√©es enrichies'}`);
        console.log('   üîç D√©tails complets avec historique');
        console.log('');
        console.log('üìä API ENDPOINTS DISPONIBLES:');
        console.log('   üîê POST /api/auth/login - Authentification');
        console.log(`   üìä GET /api/dashboard - Dashboard ${isOdooConnected ? 'Odoo' : 'fallback'}`);
        console.log(`   üìÑ GET /api/requests - Liste des demandes ${isOdooConnected ? 'Odoo' : 'fallback'}`);
        console.log(`   üìÑ GET /api/requests/:id - D√©tail d'une demande ${isOdooConnected ? 'Odoo' : 'fallback'}`);
        console.log(`   üö® GET /api/alerts - Liste des alertes ${isOdooConnected ? 'Odoo' : 'fallback'}`);
        console.log(`   üö® GET /api/alerts/:id - D√©tail d'une alerte ${isOdooConnected ? 'Odoo' : 'fallback'}`);
        console.log('   üîß GET /api/test-odoo - Test de connexion Odoo');
        console.log('');
        console.log(`üöÄ SERVEUR AVEC INT√âGRATION ODOO ${isOdooConnected ? 'COMPL√àTE' : 'EN MODE FALLBACK'} !`);
        console.log('        ');
    });

    // Gestion de l'arr√™t propre
    process.on('SIGINT', () => {
        console.log('\nüëã Arr√™t du serveur SAMA CONAI UX...');
        server.close(() => {
            console.log('‚úÖ Serveur arr√™t√© proprement');
            process.exit(0);
        });
    });
}

// D√©marrage du serveur
startServer().catch(error => {
    console.error('‚ùå Erreur d√©marrage serveur:', error);
    process.exit(1);
});